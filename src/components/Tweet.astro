---
interface Props {
  id: string;
  username?: string;
}

const { id, username } = Astro.props;

// Twitter OEmbed API を使用してツイート情報を取得
const tweetUrl = username
  ? `https://twitter.com/${username}/status/${id}`
  : `https://twitter.com/i/status/${id}`;

let html = '';
let error = false;

try {
  const oembedUrl = `https://publish.twitter.com/oembed?url=${encodeURIComponent(tweetUrl)}&omit_script=true&lang=ja`;
  const response = await fetch(oembedUrl);

  if (response.ok) {
    const data = await response.json();
    html = data.html;
  } else {
    error = true;
    console.error(`Failed to fetch tweet ${id}: ${response.status}`);
  }
} catch (err) {
  error = true;
  console.error(`Error fetching tweet ${id}:`, err);
}
---

{error ? (
  <div class="tweet-error">
    <p>ツイートの読み込みに失敗しました</p>
    <a href={tweetUrl} target="_blank" rel="noopener noreferrer">X で見る</a>
  </div>
) : (
  <div class="tweet-wrapper" set:html={html} />
)}

<script is:inline>
  // Twitter ウィジェットスクリプトを読み込む（まだ読み込まれていない場合）
  if (!window.twttrScriptLoaded) {
    window.twttrScriptLoaded = true;
    const script = document.createElement('script');
    script.src = 'https://platform.twitter.com/widgets.js';
    script.async = true;
    script.charset = 'utf-8';
    document.body.appendChild(script);
  } else if (window.twttr && window.twttr.widgets) {
    // すでにスクリプトが読み込まれている場合は、ウィジェットを再レンダリング
    window.twttr.widgets.load();
  }
</script>

<style>
  .tweet-wrapper {
    margin: 1.5rem auto;
    max-width: 550px;
  }

  .tweet-error {
    margin: 1.5rem auto;
    max-width: 550px;
    padding: 1rem;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
    background-color: #f7f9fa;
    text-align: center;
  }

  .tweet-error p {
    margin: 0 0 0.5rem 0;
    color: #657786;
  }

  .tweet-error a {
    color: #1da1f2;
    text-decoration: none;
  }

  .tweet-error a:hover {
    text-decoration: underline;
  }
</style>
